<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Survey Perawatan - Farah Mom & Baby Care</title>
    <!-- Bootstrap 5 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(to bottom right, #fdf2f8, #e9d5ff, #dbeafe);
        min-height: 100vh;
        padding: 2rem 1rem;
      }
      .survey-card {
        background: white;
        border-radius: 1.5rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 2rem;
      }
      .section-title {
        font-size: 1.4rem;
        font-weight: bold;
        color: #a855f7;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #ec4899;
      }
      .note {
        background: #f3e8ff;
        padding: 1rem;
        border-radius: 0.75rem;
        font-size: 0.9rem;
        color: #444;
      }
      .alert-recommendation {
        background: linear-gradient(to right, #fdf2f8, #fce7f3);
        border-left: 5px solid #ec4899;
      }
      .form-check-input:checked {
        background-color: #ec4899;
        border-color: #ec4899;
      }
      .form-check-label {
        cursor: pointer;
      }
      .btn-next {
        background: linear-gradient(to right, #ec4899, #a855f7);
        border: none;
      }
      .btn-next:hover {
        background: linear-gradient(to right, #db2777, #9333ea);
      }
      .summary-item {
        background: #fcf4ff;
        border-left: 4px solid #ec4899;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="survey-card mx-auto" style="max-width: 800px" id="app"></div>
    </div>

    <script>
      const questions = [
        {
          id: "receiver",
          section: "IDENTITAS DASAR",
          question: "Siapa yang akan menerima perawatan?",
          type: "single",
          options: [
            { value: "pregnant", label: "Ibu hamil" },
            { value: "postpartum", label: "Ibu pasca melahirkan/menyusui" },
            { value: "baby", label: "Bayi (0â€“12 bulan)" },
            { value: "child", label: "Anak (1â€“10 tahun)" },
          ],
        },
        {
          id: "gender",
          question: "Jenis Kelamin (jika untuk bayi/anak):",
          type: "single",
          showIf: (ans) => ans.receiver === "baby" || ans.receiver === "child",
          options: [
            { value: "male", label: "Laki-laki" },
            { value: "female", label: "Perempuan" },
          ],
        },
        {
          id: "location",
          question: "Lokasi perawatan:",
          type: "single",
          options: [
            { value: "clinic", label: "Klinik Farah Mom & Baby Care" },
            { value: "home", label: "Homecare (di rumah)" },
          ],
        },
        {
          id: "firstVisit",
          question: "Apakah ini kunjungan pertama ke Farah Mom & Baby Care?",
          type: "single",
          options: [
            { value: "yes", label: "Ya" },
            { value: "no", label: "Tidak" },
          ],
        },
        {
          id: "generalCondition",
          section: "BAGIAN 2 â€” KONDISI UMUM",
          question: "Kondisi umum penerima treatment saat ini:",
          type: "single",
          options: [
            { value: "healthy", label: "Sehat" },
            { value: "tired", label: "Kurang fit / mudah lelah" },
            {
              value: "complaint",
              label: "Ada keluhan tertentu (jelaskan di bawah)",
            },
          ],
        },
        {
          id: "complaintDetail",
          question: "Jelaskan keluhan tertentu:",
          type: "textarea",
          showIf: (ans) => ans.generalCondition === "complaint",
        },
        {
          id: "medication",
          question: "Apakah sedang mengonsumsi obat atau suplemen tertentu?",
          type: "single",
          options: [
            { value: "yes", label: "Ya" },
            { value: "no", label: "Tidak" },
          ],
        },
        {
          id: "medicationDetail",
          question: "Sebutkan obat/suplemen:",
          type: "textarea",
          showIf: (ans) => ans.medication === "yes",
        },
        {
          id: "allergy",
          question:
            "Apakah memiliki alergi terhadap minyak pijat, essential oil, atau bahan herbal tertentu?",
          type: "single",
          options: [
            { value: "yes", label: "Ya" },
            { value: "no", label: "Tidak" },
          ],
        },
        {
          id: "allergyDetail",
          question: "Jelaskan alergi:",
          type: "textarea",
          showIf: (ans) => ans.allergy === "yes",
        },
        {
          id: "fever",
          question:
            "Apakah sedang mengalami demam (suhu tubuh di atas 37,5Â°C)?",
          type: "single",
          options: [
            { value: "yes", label: "Ya" },
            { value: "no", label: "Tidak" },
          ],
        },
        {
          id: "pregnantWeek",
          section: "BAGIAN 3A â€” IBU HAMIL",
          question: "Usia kehamilan saat ini:",
          type: "text",
          showIf: (ans) => ans.receiver === "pregnant",
          placeholder: "contoh: â€œ28 mingguâ€ atau '3 bulan'",
        },
        {
          id: "pregnantComplaints",
          question: "Keluhan yang dirasakan:",
          type: "multiple",
          showIf: (ans) => ans.receiver === "pregnant",
          options: [
            { value: "backPain", label: "Pegal punggung / pinggang" },
            { value: "swollenLegs", label: "Kaki bengkak / kram" },
            { value: "insomnia", label: "Sulit tidur" },
            { value: "shoulderPain", label: "Nyeri di bahu / leher" },
            {
              value: "relaxBonding",
              label: "Ingin relaksasi dan bonding dengan janin",
            },
            { value: "other", label: "Lainnya" },
          ],
        },
        {
          id: "pregnantOther",
          question: "Keluhan lainnya:",
          type: "textarea",
          showIf: (ans) => ans.pregnantComplaints?.includes("other"),
        },
        {
          id: "momDuration",
          section: "BAGIAN 3B â€” IBU PASCA MELAHIRKAN / MENYUSUI",
          question: "Sudah berapa lama pasca melahirkan?",
          type: "text",
          showIf: (ans) => ans.receiver === "postpartum",
          placeholder: "contoh: â€œ3 mingguâ€ atau â€œ4 bulanâ€",
        },
        {
          id: "birthType",
          question: "Jenis persalinan:",
          type: "single",
          showIf: (ans) => ans.receiver === "postpartum",
          options: [
            { value: "normal", label: "Pervaginam/Normal" },
            { value: "caesar", label: "Section Caesarea (SC)" },
          ],
        },
        {
          id: "activeBF",
          question: "Apakah sedang menyusui aktif?",
          type: "single",
          showIf: (ans) => ans.receiver === "postpartum",
          options: [
            { value: "yes", label: "Ya" },
            { value: "no", label: "Tidak" },
          ],
        },
        {
          id: "momComplaints",
          question: "Keluhan utama:",
          type: "multiple",
          showIf: (ans) => ans.receiver === "postpartum",
          options: [
            { value: "bodyPain", label: "Badan pegal / nyeri punggung" },
            { value: "lowMilk", label: "Produksi ASI menurun" },
            {
              value: "swollenBreast",
              label: "Payudara bengkak / terasa keras",
            },
            {
              value: "swollenLegs",
              label: "Kaki bengkak",
            },
            { value: "dullFace", label: "Wajah kusam / ingin relaksasi" },
            { value: "other", label: "Lainnya" },
          ],
        },
        {
          id: "momOther",
          question: "Keluhan lainnya:",
          type: "textarea",
          showIf: (ans) => ans.momComplaints?.includes("other"),
        },
        {
          id: "babyAge",
          section: "BAYI (0â€“12 BULAN)",
          question: "Usia bayi:",
          type: "text",
          showIf: (ans) => ans.receiver === "baby",
          placeholder: "contoh: â€œ3 bulanâ€",
        },
        {
          id: "babyCondition",
          question: "Kondisi bayi:",
          type: "single",
          showIf: (ans) => ans.receiver === "baby",
          options: [
            { value: "healthy", label: "Sehat & ceria" },
            { value: "unwell", label: "Kurang sehat / rewel" },
          ],
        },
        {
          id: "babyComplaints",
          question: "Keluhan bayi:",
          type: "multiple",
          showIf: (ans) => ans.receiver === "baby",
          options: [
            { value: "colic", label: "Kolik / perut kembung" },
            { value: "cold", label: "Batuk pilek ringan" },
            { value: "sleep", label: "Sulit tidur / rewel" },
            { value: "constipation", label: "Susah BAB / konstipasi" },
            { value: "appetite", label: "Nafsu makan menurun" },
            {
              value: "none",
              label:
                "Tidak ada keluhan (untuk pijat rutin / stimulasi tumbuh kembang)",
            },
          ],
        },
        {
          id: "babyAdditional",
          question: "Tambahan layanan:",
          type: "multiple",
          showIf: (ans) => ans.receiver === "baby",
          options: [
            { value: "earPiercing", label: "Tindik telinga" },
            { value: "haircut", label: "Cukur rambut botak/gundul" },
            { value: "tidak", label: "tidak ada" },
          ],
        },
        {
          id: "childAge",
          section: "ANAK (1â€“10 TAHUN)",
          question: "Usia anak:",
          type: "text",
          showIf: (ans) => ans.receiver === "child",
          placeholder: "contoh: â€œ6 tahunâ€",
        },
        {
          id: "childCondition",
          question: "Kondisi anak:",
          type: "single",
          showIf: (ans) => ans.receiver === "child",
          options: [
            { value: "healthy", label: "Sehat & aktif" },
            { value: "unwell", label: "Kurang fit" },
          ],
        },
        {
          id: "childAdditional",
          question: "Tambahan layanan:",
          type: "multiple",
          showIf: (ans) => ans.receiver === "child",
          options: [
            { value: "earPiercing", label: "Tindik telinga" },
            { value: "haircut", label: "Cukur rambut botak/gundul" },
            { value: "tidak", label: "Tidak ada" },
          ],
        },
        {
          id: "therapist",
          section: "BAGIAN 4 â€” PREFERENSI & PENJADWALAN",
          question: "Pilih therapist:",
          type: "single",
          options: [
            { value: "professional", label: "Professional Therapist" },
            { value: "special", label: "Special Therapist (Bidan)" },
            { value: "head", label: "Head Therapist (Bidan Farah / Owner)" },
          ],
        },
        {
          id: "schedule",
          question: "Waktu treatment yang diinginkan:",
          type: "datetime",
          note: "Pilih tanggal dan jam yang diinginkan",
        },
        {
          id: "notes",
          question: "Catatan tambahan dari bunda/ayah:",
          type: "textarea",
          optional: true,
        },
      ];

      let step = 0;
      let answers = {};
      let showSummary = false;

      const app = document.getElementById("app");

      function getVisibleQuestions() {
        return questions.filter((q) => !q.showIf || q.showIf(answers));
      }

      function handleAnswer(id, value, isMultiple = false) {
        if (isMultiple) {
          const current = answers[id] || [];
          if (current.includes(value)) {
            answers[id] = current.filter((v) => v !== value);
          } else {
            answers[id] = [...current, value];
          }
        } else {
          answers[id] = value;
          setTimeout(() => {
            const visible = getVisibleQuestions();
            if (step < visible.length - 1) {
              step++;
              render();
            }
          }, 300);
        }
        render();
      }

      function handleText(id, value) {
        answers[id] = value;
        render();
      }

      function nextStep() {
        const visible = getVisibleQuestions();
        if (step < visible.length - 1) {
          step++;
        } else {
          showSummary = true;
        }
        render();
      }

      function prevStep() {
        if (step > 0) step--;
        render();
      }

      function reset() {
        step = 0;
        answers = {};
        showSummary = false;
        render();
      }

      function getLabel(id, value) {
        const q = questions.find((qq) => qq.id === id);
        if (!q || !q.options) return value || "-";
        if (Array.isArray(value)) {
          return value
            .map((v) => q.options.find((o) => o.value === v)?.label || v)
            .join(", ");
        }
        return q.options.find((o) => o.value === value)?.label || value || "-";
      }

      function getRecommendations(ans) {
        const recs = [];
        const notes = [];

        if (ans.fever === "yes") {
          if (
            ans.receiver === "postpartum" &&
            (ans.momComplaints?.includes("swollenBreast") ||
              ans.momComplaints?.includes("lowMilk"))
          ) {
            notes.push(
              "âœ… Lactation Massage tetap bisa dilakukan meski demam ringan (untuk keluhan payudara/ASI)."
            );
          } else {
            notes.push(
              "âš ï¸ Treatment pijat sebaiknya ditunda hingga demam reda."
            );
          }
        }

        if (ans.allergy === "yes") {
          notes.push(
            "âš ï¸ Informasikan detail alergi ke therapist untuk penyesuaian bahan."
          );
        }

        if (ans.generalCondition === "complaint" || ans.complaintDetail) {
          notes.push(
            "âš ï¸ Keluhan tambahan akan dibahas langsung dengan therapist."
          );
        }

        if (ans.receiver === "pregnant") {
          let fokus = [];
          const complaints = ans.pregnantComplaints || [];
          if (
            complaints.includes("backPain") ||
            complaints.includes("shoulderPain")
          )
            fokus.push("pegal punggung/pinggang/bahu/leher");
          if (complaints.includes("swollenLegs"))
            fokus.push("kaki bengkak/kram");
          if (
            complaints.includes("insomnia") ||
            complaints.includes("relaxBonding")
          )
            fokus.push("relaksasi & bonding janin");

          const fokusText =
            fokus.length > 0
              ? `dengan fokus: ${fokus.join(", ")}`
              : "relaksasi umum & persiapan persalinan";
          recs.push(`Pregnancy Massage ${fokusText}`);

          if (complaints.length >= 2)
            recs.push(
              "Saran tambahan: Totok Wajah & Masker Wajah untuk relaksasi ekstra"
            );
        } else if (ans.receiver === "postpartum") {
          let main = "Postpartum Massage untuk pemulihan pasca melahirkan";
          let fokus = [];
          const complaints = ans.momComplaints || [];

          if (
            complaints.includes("lowMilk") ||
            complaints.includes("swollenBreast")
          ) {
            fokus.push(
              "dukung ASI & atasi payudara bengkak (Lactation Massage wajib)"
            );
          }
          if (complaints.includes("bodyPain"))
            fokus.push("pegal badan & nyeri punggung");
          if (complaints.includes("swollenLegs")) fokus.push("kaki bengkak");
          if (complaints.includes("dullFace"))
            fokus.push("wajah cerah & relaksasi (Totok Wajah)");

          if (fokus.length > 0) main += ` dengan fokus: ${fokus.join(", ")}`;
          recs.push(main);

          if (complaints.length >= 2);
        } else if (ans.receiver === "baby") {
          const complaints = ans.babyComplaints || [];
          let fokus = [];

          if (
            complaints.includes("colic") ||
            complaints.includes("constipation")
          )
            fokus.push("perut kembung/susah BAB");
          if (complaints.includes("cold")) fokus.push("batuk pilek ringan");
          if (complaints.includes("sleep")) fokus.push("sulit tidur");
          if (complaints.includes("appetite")) fokus.push("nafsu makan");

          if (complaints.includes("none") || ans.babyCondition === "healthy") {
            recs.push(
              "Baby Massage + Baby Spa (rutin untuk stimulasi tumbuh kembang)"
            );
          } else {
            const fokusText =
              fokus.length > 0
                ? `dengan fokus: ${fokus.join(", ")}`
                : "relaksasi umum";
            recs.push(`Pediatric Medical Massage
For Baby ${fokusText}`);
          }

          if (ans.babyAdditional?.includes("earPiercing"))
            recs.push("Tindik Telinga Bayi");
          if (ans.babyAdditional?.includes("haircut"))
            recs.push("Cukur Rambut Bayi");
        } else if (ans.receiver === "child") {
          let text = "Pediatric Medical Massage (Kids Treatment)";
          if (ans.childCondition === "unwell")
            text += " dengan fokus pemulihan ringan";
          recs.push(text);

          if (ans.childAdditional?.includes("earPiercing"))
            recs.push("Tindik Telinga Anak");
          if (ans.childAdditional?.includes("haircut"))
            recs.push("Cukur Rambut Anak");
          recs.push("Opsional: Bubble Bath & Body Mask");
        }

        return { recs, notes };
      }

      function copySummary() {
        let text = "Ringkasan Survey - Farah Mom & Baby Care\n";
        text += "Tanggal: " + new Date().toLocaleDateString("id-ID") + "\n\n";

        let currentSection = "";
        questions.forEach((q) => {
          if (q.showIf && !q.showIf(answers)) return;
          if (!answers[q.id]) return;

          if (q.section && q.section !== currentSection) {
            currentSection = q.section;
            text += currentSection + "\n";
          }

          const displayValue = getLabel(q.id, answers[q.id]);
          text += q.question + "\n";
          text += displayValue + "\n\n";
        });

        const { recs, notes } = getRecommendations(answers);
        text += "REKOMENDASI TREATMENT\n";
        text += recs.join("\n") + "\n";
        if (notes.length > 0) {
          text += "\nCATATAN PENTING\n";
          text += notes.join("\n") + "\n";
        }

        navigator.clipboard
          .writeText(text)
          .then(() => {
            alert("Ringkasan + rekomendasi berhasil disalin!");
          })
          .catch(() => {
            alert("Gagal copy otomatis. Silakan select manual.");
          });
      }

      function renderSummary() {
        const { recs, notes } = getRecommendations(answers);

        let html = `
      <div class="text-center mb-5">
        <h2 class="display-6">Terima Kasih!</h2>
        <p class="lead text-muted">Survey selesai. Berikut rekomendasi treatment yang disesuaikan dengan keluhan Anda.</p>
        <div class="d-flex justify-content-center gap-3 mb-4">
          <button class="btn btn-success px-4" onclick="copySummary()">
            ðŸ“‹ Copy Ringkasan dan Rekomendasi
          </button>
        </div>
      </div>`;

        html += `
      <div class="section-title mb-4">REKOMENDASI TREATMENT</div>
      <div class="alert alert-recommendation p-4 mb-5">
        <h5 class="mb-3">Rekomendasi berdasarkan keluhan:</h5>
        <ul class="mb-3">
          ${recs.map((r) => `<li><strong>${r}</strong></li>`).join("")}
        </ul>
        ${
          notes.length > 0
            ? `
        <hr>
        <h6>Catatan penting:</h6>
        <ul>
          ${notes.map((n) => `<li>${n}</li>`).join("")}
        </ul>`
            : ""
        }
        
      </div>`;

        let currentSection = "";
        html += `<div class="section-title mb-4">RINGKASAN JAWABAN ANDA</div><div class="row">`;

        questions.forEach((q) => {
          if (q.showIf && !q.showIf(answers)) return;
          if (!answers[q.id]) return;

          if (q.section && q.section !== currentSection) {
            currentSection = q.section;
            html += `</div><div class="section-title mt-5">${currentSection}</div><div class="row">`;
          }

          const value = answers[q.id];
          const displayValue = getLabel(q.id, value);

          html += `
        <div class="col-12 mb-3">
          <div class="p-3 rounded summary-item">
            <strong>${q.question}</strong><br>
            <span class="text-muted">${displayValue}</span>
          </div>
        </div>`;
        });

        html += `</div>
      <div class="mt-5">
        <button class="btn btn-primary btn-lg w-100 btn-next" onclick="reset()">Isi Survey Baru</button>
      </div>`;

        app.innerHTML = html;
      }

      function render() {
        if (showSummary) {
          renderSummary();
          return;
        }

        const visible = getVisibleQuestions();
        const current = visible[step];

        if (!current) {
          app.innerHTML = "";
          return;
        }

        const isAnswered = (() => {
          if (current.optional) return true;
          if (!answers[current.id]) return false;
          if (current.type === "multiple")
            return answers[current.id]?.length > 0;
          if (current.type === "single") return true;
          if (
            current.type === "text" ||
            current.type === "textarea" ||
            current.type === "datetime"
          )
            return answers[current.id]?.trim().length > 0;
          return false;
        })();

        let sectionHtml = "";
        if (
          current.section &&
          (step === 0 || visible[step - 1]?.section !== current.section)
        ) {
          sectionHtml = `<div class="section-title">${current.section}</div>`;
        }

        let optionsHtml = "";
        if (current.options) {
          const inputType = current.type === "multiple" ? "checkbox" : "radio";
          const name = current.id;
          optionsHtml = current.options
            .map((opt) => {
              const selected =
                current.type === "multiple"
                  ? (answers[current.id] || []).includes(opt.value)
                  : answers[current.id] === opt.value;
              return `
                <div class="form-check">
                  <input class="form-check-input" type="${inputType}" name="${name}" id="${
                opt.value
              }" value="${opt.value}"
                         ${selected ? "checked" : ""} onchange="handleAnswer('${
                current.id
              }', '${opt.value}', ${current.type === "multiple"})">
                  <label class="form-check-label fw-medium" for="${opt.value}">
                    ${opt.label}
                  </label>
                </div>`;
            })
            .join("");
        }

        let inputHtml = "";
        if (current.type === "text") {
          inputHtml = `<input type="text" class="form-control mt-3" placeholder="${
            current.placeholder || ""
          }" value="${answers[current.id] || ""}" oninput="handleText('${
            current.id
          }', this.value)">`;
        } else if (current.type === "textarea") {
          inputHtml = `<textarea class="form-control mt-3" rows="4" placeholder="${
            current.placeholder || ""
          }" oninput="handleText('${current.id}', this.value)">${
            answers[current.id] || ""
          }</textarea>`;
        } else if (current.type === "datetime") {
          let formattedValue = answers[current.id] || "";
          inputHtml = `<input type="datetime-local" class="form-control mt-3" value="${formattedValue}" onchange="handleText('${current.id}', this.value)">`;
        }

        let noteHtml = "";
        if (current.id === "fever") {
          const receiver = answers.receiver;
          let noteText = "";
          if (receiver === "pregnant") {
            noteText =
              "Demam pada ibu hamil: disarankan menunda hingga stabil.";
          } else if (receiver === "postpartum") {
            noteText =
              "Lactation Massage tetap bisa untuk keluhan payudara meski demam ringan.";
          } else if (receiver === "baby" || receiver === "child") {
            noteText =
              "Demam pada bayi/anak: treatment ditunda hingga suhu normal.";
          }
          if (noteText) {
            noteHtml = `<div class="note mb-4">${noteText}</div>`;
          }
        } else if (current.note) {
          noteHtml = `<div class="note mb-4">${current.note}</div>`;
        }

        app.innerHTML = `
      ${sectionHtml}
      <div class="mb-4">
        <small class="text-muted">Pertanyaan ${step + 1} dari ${
          visible.length
        }</small>
        <div class="progress mt-2" style="height: 8px;">
          <div class="progress-bar bg-pink" role="progressbar" style="width: ${
            ((step + 1) / visible.length) * 100
          }%; background: linear-gradient(to right, #ec4899, #a855f7)!important;"></div>
        </div>
      </div>
      <h4 class="mb-4">${current.question}</h4>
      ${noteHtml}
      ${
        current.type === "multiple"
          ? '<small class="text-muted d-block mb-3">Pilih satu atau lebih</small>'
          : ""
      }
      ${optionsHtml}
      ${inputHtml}
      <div class="d-flex gap-3 mt-5">
        ${
          step > 0
            ? `<button class="btn btn-outline-secondary px-4" onclick="prevStep()">Kembali</button>`
            : ""
        }
        <button class="btn btn-primary px-5 flex-grow-1 btn-next" ${
          !isAnswered ? "disabled" : ""
        } onclick="nextStep()">
          ${
            step === visible.length - 1 ? "Selesai & Lihat Ringkasan" : "Lanjut"
          }
        </button>
      </div>
    `;

        if (current.type === "text" || current.type === "textarea") {
          const input = app.querySelector(
            "input.form-control, textarea.form-control"
          );
          if (input) {
            input.focus();
            input.selectionStart = input.selectionEnd = input.value.length;
          }
        }
      }

      render();
    </script>
  </body>
</html>
