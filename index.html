<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Survey Perawatan - Farah Mom & Baby Care</title>
    <!-- Bootstrap 5 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(to bottom right, #fdf2f8, #e9d5ff, #dbeafe);
        min-height: 100vh;
        padding: 2rem 1rem;
      }
      .survey-card {
        background: white;
        border-radius: 1.5rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 2rem;
      }
      .section-title {
        font-size: 1.4rem;
        font-weight: bold;
        color: #a855f7;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #ec4899;
      }
      .note {
        background: #f3e8ff;
        padding: 1rem;
        border-radius: 0.75rem;
        font-size: 0.9rem;
        color: #444;
      }
      .alert-recommendation {
        background: linear-gradient(to right, #fdf2f8, #fce7f3);
        border-left: 5px solid #ec4899;
      }
      .form-check-input:checked {
        background-color: #ec4899;
        border-color: #ec4899;
      }
      .form-check-label {
        cursor: pointer;
      }
      .btn-next {
        background: linear-gradient(to right, #ec4899, #a855f7);
        border: none;
      }
      .btn-next:hover {
        background: linear-gradient(to right, #db2777, #9333ea);
      }
      .summary-item {
        background: #fcf4ff;
        border-left: 4px solid #ec4899;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="survey-card mx-auto" style="max-width: 800px" id="app"></div>
    </div>

    <script>
      const questions = [
        {
          id: "receiver",
          section: "IDENTITAS DASAR",
          question: "Siapa yang akan menerima perawatan?",
          type: "single",
          options: [
            { value: "pregnant", label: "Ibu hamil" },
            { value: "postpartum", label: "Ibu pasca melahirkan/menyusui" },
            { value: "baby", label: "Bayi (0â€“12 bulan)" },
            { value: "child", label: "Anak (1â€“10 tahun)" },
          ],
        },
        {
          id: "gender",
          question: "Jenis Kelamin:",
          type: "single",
          showIf: (ans) => ans.receiver === "baby" || ans.receiver === "child",
          options: [
            { value: "male", label: "Laki-laki" },
            { value: "female", label: "Perempuan" },
          ],
        },
        {
          id: "generalCondition",
          section: "KONDISI UMUM",
          question: "Kondisi umum penerima treatment saat ini:",
          type: "single",
          options: [
            { value: "healthy", label: "Sehat" },
            { value: "tired", label: "Kurang fit / mudah lelah" },
            {
              value: "complaint",
              label: "Ada keluhan tertentu (jelaskan di bawah)",
            },
          ],
        },
        {
          id: "complaintDetail",
          question: "Jelaskan keluhan tertentu:",
          type: "textarea",
          showIf: (ans) => ans.generalCondition === "complaint",
        },
        {
          id: "location",
          question: "Lokasi perawatan:",
          type: "single",
          options: [
            { value: "clinic", label: "Klinik Farah Mom & Baby Care" },
            { value: "home", label: "Homecare (di rumah)" },
          ],
        },
        {
          id: "pregnantComplaints",
          section: "IBU HAMIL",
          question: "Keluhan yang dirasakan:",
          type: "multiple",
          showIf: (ans) => ans.receiver === "pregnant",
          options: [
            { value: "backPain", label: "Pegal punggung / pinggang" },
            { value: "swollenLegs", label: "Kaki bengkak / kram" },
            { value: "insomnia", label: "Sulit tidur" },
            {
              value: "anxiousBirth",
              label: "Cemas menghadapi persalinan / kurang persiapan",
            },
            {
              value: "lackKnowledge",
              label: "Kurang pengetahuan parenting & perawatan bayi",
            },
            { value: "wantExercise", label: "Ingin berolahraga" },
            { value: "other", label: "Lainnya" },
          ],
        },
        {
          id: "pregnantOther",
          question: "Keluhan lainnya:",
          type: "textarea",
          showIf: (ans) => ans.pregnantComplaints?.includes("other"),
        },
        {
          id: "pregnantAdditional",
          question: "Layanan tambahan yang diinginkan:",
          type: "multiple",
          showIf: (ans) => ans.receiver === "pregnant",
          options: [
            { value: "totokScrub", label: "Totok Wajah & Body Scrub" },
            { value: "bloodSugar", label: "Pemeriksaan Gula Darah" },
            { value: "cholesterol", label: "Pemeriksaan Kolesterol" },
            { value: "uricAcid", label: "Pemeriksaan Asam Urat" },
            { value: "breastMask", label: "Masker Payudara" },
            { value: "none", label: "Tidak ada" },
          ],
        },
        {
          id: "pregnantWeek",
          question: "Usia kehamilan saat ini:",
          type: "text",
          showIf: (ans) => ans.receiver === "pregnant",
          placeholder: "contoh: â€œ28 mingguâ€ atau '3 bulan'",
        },
        {
          id: "momComplaints",
          section: "IBU PASCA MELAHIRKAN / MENYUSUI",
          question: "Keluhan utama:",
          type: "multiple",
          showIf: (ans) => ans.receiver === "postpartum",
          options: [
            { value: "lowMilk", label: "Produksi ASI menurun" },
            {
              value: "swollenBreast",
              label: "Payudara bengkak / terasa keras",
            },
            {
              value: "swollenLegs",
              label: "Kaki bengkak",
            },
            { value: "dullFace", label: "Wajah kusam / ingin relaksasi" },
            { value: "other", label: "Lainnya" },
          ],
        },
        {
          id: "momOther",
          question: "Keluhan lainnya:",
          type: "textarea",
          showIf: (ans) => ans.momComplaints?.includes("other"),
        },
        {
          id: "momAdditional",
          question: "Layanan tambahan yang diinginkan:",
          type: "multiple",
          showIf: (ans) => ans.receiver === "postpartum",
          options: [
            { value: "totokMasker", label: "Totok Wajah & Masker Wajah" },
            { value: "bodyScrub", label: "Body Scrub" },
            { value: "bloodSugar", label: "Pemeriksaan Gula Darah" },
            { value: "cholesterol", label: "Pemeriksaan Kolesterol" },
            { value: "uricAcid", label: "Pemeriksaan Asam Urat" },
            { value: "breastMask", label: "Masker Payudara" },
            { value: "none", label: "Tidak ada" },
          ],
        },
        {
          id: "momDuration",
          question: "Sudah berapa lama pasca melahirkan?",
          type: "text",
          showIf: (ans) => ans.receiver === "postpartum",
          placeholder: "contoh: â€œ3 mingguâ€ atau â€œ4 bulanâ€",
        },
        {
          id: "birthType",
          question: "Jenis persalinan:",
          type: "single",
          showIf: (ans) => ans.receiver === "postpartum",
          options: [
            { value: "normal", label: "Pervaginam/Normal" },
            { value: "caesar", label: "Section Caesarea (SC)" },
          ],
        },
        {
          id: "activeBF",
          question: "Apakah sedang menyusui aktif?",
          type: "single",
          showIf: (ans) => ans.receiver === "postpartum",
          options: [
            { value: "yes", label: "Ya" },
            { value: "no", label: "Tidak" },
          ],
        },
        {
          id: "babyComplaints",
          section: "BAYI (0â€“12 BULAN)",
          question: "Keluhan bayi:",
          type: "multiple",
          showIf: (ans) => ans.receiver === "baby",
          options: [
            { value: "colic", label: "Kolik / perut kembung" },
            { value: "cold", label: "Batuk pilek ringan" },
            { value: "sleep", label: "Sulit tidur / rewel" },
            { value: "constipation", label: "Susah BAB / konstipasi" },
            { value: "appetite", label: "Nafsu makan menurun" },
            {
              value: "none",
              label:
                "Tidak ada keluhan (untuk pijat rutin / stimulasi tumbuh kembang)",
            },
          ],
        },
        {
          id: "babyAdditional",
          question: "Layanan tambahan yang diinginkan:",
          type: "multiple",
          showIf: (ans) => ans.receiver === "baby",
          options: [
            { value: "earPiercing", label: "Tindik Telinga" },
            { value: "haircut", label: "Cukur Rambut Botak/Gundul (Hair Cut)" },
            {
              value: "bubble",
              label:
                "<strong>Bubble Bath (Tersedia jika bunda memilih di Klinik)",
            },
            { value: "mask", label: "Body Mask" },
            { value: "none", label: "Tidak ada" },
          ],
        },
        {
          id: "babyAge",
          question: "Usia bayi:",
          type: "text",
          showIf: (ans) => ans.receiver === "baby",
          placeholder: "contoh: â€œ3 bulanâ€",
        },
        {
          id: "babyCondition",
          question: "Kondisi bayi saat ini:",
          type: "single",
          showIf: (ans) => ans.receiver === "baby",
          options: [
            { value: "healthy", label: "Sehat & ceria" },
            { value: "unwell", label: "Kurang sehat / rewel" },
          ],
        },
        {
          id: "childComplaints",
          section: "ANAK (1â€“10 TAHUN)",
          question: "Keluhan anak:",
          type: "multiple",
          showIf: (ans) => ans.receiver === "child",
          options: [
            { value: "cold", label: "Batuk pilek ringan" },
            { value: "sleep", label: "Sulit tidur / rewel malam" },
            { value: "constipation", label: "Susah BAB / konstipasi" },
            { value: "appetite", label: "Nafsu makan menurun" },
            { value: "tired", label: "Mudah lelah / kurang energi" },
            {
              value: "none",
              label: "Tidak ada keluhan (untuk pijat rutin & relaksasi)",
            },
          ],
        },
        {
          id: "childAdditional",
          question: "Layanan tambahan yang diinginkan:",
          type: "multiple",
          showIf: (ans) => ans.receiver === "child",
          options: [
            { value: "earPiercing", label: "Tindik Telinga" },
            {
              value: "bubble",
              label:
                "<strong>Bubble Bath (Tersedia jika bunda memilih di Klinik)",
            },
            { value: "mask", label: "Body Mask" },
            { value: "none", label: "Tidak ada" },
          ],
        },
        {
          id: "childAge",
          question: "Usia anak:",
          type: "text",
          showIf: (ans) => ans.receiver === "child",
          placeholder: "contoh: â€œ6 tahunâ€",
        },
        {
          id: "medication",
          question: "Apakah sedang mengonsumsi obat atau suplemen tertentu?",
          type: "single",
          showIf: (ans) => {
            if (ans.receiver !== "pregnant") return true;
            const complaints = ans.pregnantComplaints || [];
            const physicalComplaints = [
              "backPain",
              "swollenLegs",
              "insomnia",
              "other",
            ];
            return complaints.some((c) => physicalComplaints.includes(c));
          },
          options: [
            { value: "yes", label: "Ya" },
            { value: "no", label: "Tidak" },
          ],
        },
        {
          id: "medicationDetail",
          question: "Sebutkan obat/suplemen:",
          type: "textarea",
          showIf: (ans) => ans.medication === "yes",
        },
        {
          id: "allergy",
          question:
            "Apakah memiliki alergi terhadap minyak pijat, essential oil, atau bahan herbal tertentu?",
          type: "single",
          showIf: (ans) => {
            if (ans.receiver !== "pregnant") return true;
            const complaints = ans.pregnantComplaints || [];
            const physicalComplaints = [
              "backPain",
              "swollenLegs",
              "insomnia",
              "other",
            ];
            return complaints.some((c) => physicalComplaints.includes(c));
          },
          options: [
            { value: "yes", label: "Ya" },
            { value: "no", label: "Tidak" },
          ],
        },
        {
          id: "allergyDetail",
          question: "Jelaskan alergi:",
          type: "textarea",
          showIf: (ans) => ans.allergy === "yes",
        },
        {
          id: "fever",
          question:
            "Apakah sedang mengalami demam (suhu tubuh di atas 37,5Â°C)?",
          type: "single",
          showIf: (ans) => {
            if (ans.receiver !== "pregnant") return true;
            const complaints = ans.pregnantComplaints || [];
            const physicalComplaints = [
              "backPain",
              "swollenLegs",
              "insomnia",
              "other",
            ];
            return complaints.some((c) => physicalComplaints.includes(c));
          },
          options: [
            { value: "yes", label: "Ya" },
            { value: "no", label: "Tidak" },
          ],
        },
        {
          id: "firstVisit",
          section: "PREFERENSI & PENJADWALAN",
          question: "Apakah ini layanan pertama dari Farah Mom & Baby Care?",
          type: "single",
          options: [
            { value: "yes", label: "Ya" },
            { value: "no", label: "Tidak" },
          ],
        },
        {
          id: "therapist",
          question: "Pilih therapist:",
          type: "single",
          options: [
            { value: "professional", label: "Professional Therapist" },
            { value: "special", label: "Special Therapist (Bidan)" },
            { value: "head", label: "Head Therapist (Bidan Farah / Owner)" },
          ],
        },
        {
          id: "schedule",
          question: "Waktu treatment yang diinginkan:",
          type: "datetime",
          note: "Pilih tanggal dan jam yang diinginkan",
        },
        {
          id: "notes",
          question: "Catatan tambahan dari bunda/ayah:",
          type: "textarea",
          optional: true,
        },
      ];

      let step = 0;
      let answers = {};
      let showSummary = false;

      const app = document.getElementById("app");

      function getVisibleQuestions() {
        return questions.filter((q) => !q.showIf || q.showIf(answers));
      }

      function handleAnswer(id, value, isMultiple = false) {
        if (isMultiple) {
          const current = answers[id] || [];
          if (current.includes(value)) {
            answers[id] = current.filter((v) => v !== value);
          } else {
            answers[id] = [...current, value];
          }
        } else {
          answers[id] = value;
          setTimeout(() => {
            const visible = getVisibleQuestions();
            if (step < visible.length - 1) {
              step++;
              render();
            }
          }, 300);
        }
        render();
      }

      function handleText(id, value) {
        answers[id] = value;
        render();
      }

      function nextStep() {
        const visible = getVisibleQuestions();
        if (step < visible.length - 1) {
          step++;
        } else {
          showSummary = true;
        }
        render();
      }

      function prevStep() {
        if (step > 0) step--;
        render();
      }

      function reset() {
        step = 0;
        answers = {};
        showSummary = false;
        render();
      }

      function getLabel(id, value) {
        const q = questions.find((qq) => qq.id === id);
        if (!q || !q.options) return value || "-";
        if (Array.isArray(value)) {
          return value
            .map((v) => q.options.find((o) => o.value === v)?.label || v)
            .join(", ");
        }
        return q.options.find((o) => o.value === value)?.label || value || "-";
      }

      function getRecommendations(ans) {
        const recs = [];

        if (ans.receiver === "pregnant") {
          const complaints = ans.pregnantComplaints || [];
          let fokus = [];
          if (complaints.includes("backPain")) {
            fokus.push("nyeri punggung & pinggang");
          }
          if (complaints.includes("insomnia")) {
            fokus.push("mengatasi sulit tidur");
          }

          const fokusText =
            fokus.length > 0
              ? `(khusus atasi ${fokus.join(", ")})`
              : "(relaksasi umum & persiapan persalinan gentle)";

          if (
            fokus.length > 0 ||
            complaints.includes("swollenLegs") ||
            complaints.includes("other")
          ) {
            recs.push(`Pregnancy Massage ${fokusText}`);
          }

          if (complaints.includes("swollenLegs")) {
            recs.push("Foot Spa (mengurangi bengkak & kram pada kaki)");
          }

          if (complaints.includes("anxiousBirth")) {
            recs.push("Birthing Essentials Private Class");
          }
          if (complaints.includes("lackKnowledge")) {
            recs.push("Beginner Parenting Private Course");
          }
          if (
            complaints.includes("anxiousBirth") &&
            complaints.includes("lackKnowledge")
          ) {
            recs.push(
              "Comprehensive Course (paket lengkap birthing & parenting)",
            );
          }
          if (complaints.includes("wantExercise")) {
            recs.push("Senam Hamil");
          }

          if (
            ans.pregnantAdditional &&
            !ans.pregnantAdditional.includes("none")
          ) {
            if (ans.pregnantAdditional.includes("totokScrub")) {
              recs.push(
                "Totok Wajah & Body Scrub (relaksasi wajah & kulit cerah)",
              );
            }
            if (ans.pregnantAdditional.includes("bloodSugar")) {
              recs.push("Pemeriksaan Gula Darah");
            }
            if (ans.pregnantAdditional.includes("cholesterol")) {
              recs.push("Pemeriksaan Kolesterol");
            }
            if (ans.pregnantAdditional.includes("uricAcid")) {
              recs.push("Pemeriksaan Asam Urat");
            }
            if (ans.pregnantAdditional.includes("breastMask")) {
              recs.push("Masker Payudara");
            }
          }
        } else if (ans.receiver === "postpartum") {
          const complaints = ans.momComplaints || [];
          let hasBodyIssue =
            complaints.includes("bodyPain") ||
            complaints.includes("swollenLegs");

          if (hasBodyIssue || complaints.length === 0) {
            let bodyFokus = [];
            if (complaints.includes("bodyPain"))
              bodyFokus.push("nyeri punggung & badan pegal");
            const bodyText =
              bodyFokus.length > 0
                ? `(fokus ${bodyFokus.join(", ")})`
                : "(pemulihan pasca melahirkan umum)";
            recs.push(`Postpartum Massage ${bodyText}`);
          }

          if (complaints.includes("swollenLegs")) {
            recs.push("Foot Spa (mengurangi bengkak pada kaki)");
          }

          if (
            complaints.includes("lowMilk") ||
            complaints.includes("swollenBreast")
          ) {
            recs.push("Lactation Massage (1 Hari - 24 Bulan Pasca Persalinan)");
          }

          if (complaints.includes("dullFace")) {
            recs.push(
              "Totok Wajah & Masker Wajah (wajah cerah, segar & relaksasi mendalam)",
            );
          }

          if (ans.momAdditional && !ans.momAdditional.includes("none")) {
            if (
              ans.momAdditional.includes("totokMasker") &&
              !complaints.includes("dullFace")
            ) {
              recs.push("Totok Wajah & Masker Wajah");
            }
            if (ans.momAdditional.includes("bodyScrub")) {
              recs.push("Body Scrub (kulit halus & detox pasca melahirkan)");
            }
            if (ans.momAdditional.includes("bloodSugar")) {
              recs.push("Pemeriksaan Gula Darah");
            }
            if (ans.momAdditional.includes("cholesterol")) {
              recs.push("Pemeriksaan Kolesterol");
            }
            if (ans.momAdditional.includes("uricAcid")) {
              recs.push("Pemeriksaan Asam Urat");
            }
            if (ans.momAdditional.includes("breastMask")) {
              recs.push("Masker Payudara");
            }
          }
        } else if (ans.receiver === "baby") {
          const complaints = ans.babyComplaints || [];
          let fokus = [];
          if (
            complaints.includes("colic") ||
            complaints.includes("constipation")
          )
            fokus.push("perut kembung & susah BAB");
          if (complaints.includes("cold")) fokus.push("batuk pilek ringan");
          if (complaints.includes("sleep")) fokus.push("sulit tidur & rewel");
          if (complaints.includes("appetite"))
            fokus.push("nafsu makan menurun");

          const fokusText =
            fokus.length > 0
              ? `(khusus atasi ${fokus.join(", ")})`
              : "(rutin untuk stimulasi tumbuh kembang & relaksasi)";

          recs.push(`Baby Massage + Baby Spa ${fokusText}`);

          if (ans.babyAdditional && !ans.babyAdditional.includes("none")) {
            if (ans.babyAdditional.includes("earPiercing"))
              recs.push("Tindik Telinga");
            if (ans.babyAdditional.includes("haircut"))
              recs.push("Cukur Rambut (Hair Cut)");
            if (ans.babyAdditional.includes("bubble"))
              recs.push("Bubble Bath (relaksasi air hangat)");
            if (ans.babyAdditional.includes("mask"))
              recs.push("Body Mask (kulit bayi lembut)");
          }
        } else if (ans.receiver === "child") {
          const complaints = ans.childComplaints || [];
          let fokus = [];
          if (complaints.includes("cold")) fokus.push("batuk pilek ringan");
          if (complaints.includes("sleep"))
            fokus.push("sulit tidur & rewel malam");
          if (complaints.includes("constipation")) fokus.push("susah BAB");
          if (complaints.includes("appetite"))
            fokus.push("nafsu makan menurun");
          if (complaints.includes("tired")) fokus.push("mudah lelah");

          const fokusText =
            fokus.length > 0
              ? `(khusus atasi ${fokus.join(", ")})`
              : "(rutin untuk relaksasi, stimulasi & kesehatan anak)";

          recs.push(`Pediatric Medical Massage ${fokusText}`);

          if (ans.childAdditional && !ans.childAdditional.includes("none")) {
            if (ans.childAdditional.includes("earPiercing"))
              recs.push("Tindik Telinga");
            if (ans.childAdditional.includes("bubble"))
              recs.push("Bubble Bath (spa menyenangkan)");
            if (ans.childAdditional.includes("mask"))
              recs.push("Body Mask (kulit sehat & lembut)");
          }
        }

        return { recs: [...new Set(recs)] };
      }

      function copySummary() {
        let text = "Ringkasan Survey - Farah Mom & Baby Care\n";
        text += "Tanggal: " + new Date().toLocaleDateString("id-ID") + "\n\n";

        let currentSection = "";
        questions.forEach((q) => {
          if (q.showIf && !q.showIf(answers)) return;
          if (!answers[q.id]) return;

          if (q.section && q.section !== currentSection) {
            currentSection = q.section;
            text += currentSection + "\n";
          }

          const displayValue = getLabel(q.id, answers[q.id]);
          text += q.question + "\n";
          text += displayValue + "\n\n";
        });

        const { recs } = getRecommendations(answers);
        text += "REKOMENDASI TREATMENT\n";
        text += recs.join("\n") + "\n";

        navigator.clipboard
          .writeText(text)
          .then(() => {
            alert("Ringkasan + rekomendasi berhasil disalin!");
          })
          .catch(() => {
            alert("Gagal copy otomatis. Silakan select manual.");
          });
      }

      function renderSummary() {
        const { recs } = getRecommendations(answers);

        let html = `
      <div class="text-center mb-5">
        <h2 class="display-6">Terima Kasih!</h2>
        <p class="lead text-muted">Survey selesai. Berikut rekomendasi treatment yang disesuaikan dengan keluhan Anda.</p>
        <div class="d-flex justify-content-center gap-3 mb-4">
          <button class="btn btn-success px-4" onclick="copySummary()">
            ðŸ“‹ Copy Ringkasan dan Rekomendasi
          </button>
        </div>
      </div>`;

        html += `
      <div class="section-title mb-4">REKOMENDASI TREATMENT</div>
      <div class="alert alert-recommendation p-4 mb-5">
        <h5 class="mb-3">Rekomendasi berdasarkan keluhan:</h5>
        <ul class="mb-3">
          ${recs.map((r) => `<li><strong>${r}</strong></li>`).join("")}
        </ul>
      </div>`;

        let currentSection = "";
        html += `<div class="section-title mb-4">RINGKASAN JAWABAN ANDA</div><div class="row">`;

        questions.forEach((q) => {
          if (q.showIf && !q.showIf(answers)) return;
          if (!answers[q.id]) return;

          if (q.section && q.section !== currentSection) {
            currentSection = q.section;
            html += `</div><div class="section-title mt-5">${currentSection}</div><div class="row">`;
          }

          const value = answers[q.id];
          const displayValue = getLabel(q.id, value);

          html += `
        <div class="col-12 mb-3">
          <div class="p-3 rounded summary-item">
            <strong>${q.question}</strong><br>
            <span class="text-muted">${displayValue}</span>
          </div>
        </div>`;
        });

        html += `</div>
      <div class="mt-5">
        <button class="btn btn-primary btn-lg w-100 btn-next" onclick="reset()">Isi Survey Baru</button>
      </div>`;

        app.innerHTML = html;
      }

      function render() {
        if (showSummary) {
          renderSummary();
          return;
        }

        const visible = getVisibleQuestions();
        const current = visible[step];

        if (!current) {
          app.innerHTML = "";
          return;
        }

        const isAnswered = (() => {
          if (current.optional) return true;
          if (!answers[current.id]) return false;
          if (current.type === "multiple")
            return (answers[current.id] || []).length > 0;
          if (current.type === "single") return true;
          if (
            current.type === "text" ||
            current.type === "textarea" ||
            current.type === "datetime"
          )
            return answers[current.id]?.trim().length > 0;
          return false;
        })();

        let sectionHtml = "";
        if (
          current.section &&
          (step === 0 || visible[step - 1]?.section !== current.section)
        ) {
          sectionHtml = `<div class="section-title">${current.section}</div>`;
        }

        let effectiveOptions = current.options || [];
        let extraNote = "";

        if (current.id === "therapist" && answers.receiver === "pregnant") {
          effectiveOptions = current.options.filter(
            (opt) => opt.value !== "professional",
          );
          extraNote = `<div class="note mb-4">Untuk ibu hamil, treatment hanya dilakukan oleh therapist bidan terlatih.</div>`;
          if (answers.therapist === "professional") {
            answers.therapist = undefined;
          }
        }

        // Filter Bubble Bath untuk bayi jika homecare
        if (current.id === "babyAdditional" && answers.location === "home") {
          effectiveOptions = current.options.filter(
            (opt) => opt.value !== "bubble",
          );
          extraNote = `<div class="note mb-4">Bubble Bath hanya tersedia di klinik (tidak untuk homecare).</div>`;
          if (
            answers.babyAdditional &&
            answers.babyAdditional.includes("bubble")
          ) {
            answers.babyAdditional = answers.babyAdditional.filter(
              (v) => v !== "bubble",
            );
          }
        }

        // Filter Bubble Bath untuk anak jika homecare (BARU DITAMBAHKAN)
        if (current.id === "childAdditional" && answers.location === "home") {
          effectiveOptions = current.options.filter(
            (opt) => opt.value !== "bubble",
          );
          extraNote = `<div class="note mb-4">Bubble Bath hanya tersedia di klinik (tidak untuk homecare).</div>`;
          if (
            answers.childAdditional &&
            answers.childAdditional.includes("bubble")
          ) {
            answers.childAdditional = answers.childAdditional.filter(
              (v) => v !== "bubble",
            );
          }
        }

        let optionsHtml = "";
        if (effectiveOptions.length > 0) {
          const inputType = current.type === "multiple" ? "checkbox" : "radio";
          const name = current.id;
          optionsHtml = effectiveOptions
            .map((opt) => {
              const selected =
                current.type === "multiple"
                  ? (answers[current.id] || []).includes(opt.value)
                  : answers[current.id] === opt.value;
              return `
                <div class="form-check">
                  <input class="form-check-input" type="${inputType}" name="${name}" id="${
                    opt.value
                  }" value="${opt.value}"
                         ${selected ? "checked" : ""} onchange="handleAnswer('${
                           current.id
                         }', '${opt.value}', ${current.type === "multiple"})">
                  <label class="form-check-label fw-medium" for="${opt.value}">
                    ${opt.label}
                  </label>
                </div>`;
            })
            .join("");
        }

        let inputHtml = "";
        if (current.type === "text") {
          inputHtml = `<input type="text" class="form-control mt-3" placeholder="${
            current.placeholder || ""
          }" value="${answers[current.id] || ""}" oninput="handleText('${
            current.id
          }', this.value)">`;
        } else if (current.type === "textarea") {
          inputHtml = `<textarea class="form-control mt-3" rows="4" placeholder="${
            current.placeholder || ""
          }" oninput="handleText('${current.id}', this.value)">${
            answers[current.id] || ""
          }</textarea>`;
        } else if (current.type === "datetime") {
          let formattedValue = answers[current.id] || "";
          inputHtml = `<input type="datetime-local" class="form-control mt-3" value="${formattedValue}" onchange="handleText('${current.id}', this.value)">`;
        }

        let noteHtml = "";
        if (current.id === "fever") {
          const receiver = answers.receiver;
          let noteText = "";
          if (receiver === "pregnant") {
            noteText =
              "Demam pada ibu hamil: disarankan menunda hingga suhu tubuh normal (36,5 - 37,5 derajat celcius).";
          } else if (receiver === "postpartum") {
            noteText =
              "Lactation Massage tetap bisa untuk keluhan payudara meski demam ringan.";
          } else if (receiver === "baby" || receiver === "child") {
            noteText =
              "Demam pada bayi/anak: treatment ditunda hingga suhu tubuh normal (36,5 - 37,5 derajat celcius).";
          }
          if (noteText) {
            noteHtml = `<div class="note mb-4">${noteText}</div>`;
          }
        } else if (current.note) {
          noteHtml = `<div class="note mb-4">${current.note}</div>`;
        }

        app.innerHTML = `
      ${sectionHtml}
      <div class="mb-4">
        <small class="text-muted">Pertanyaan ${step + 1} dari ${
          visible.length
        }</small>
        <div class="progress mt-2" style="height: 8px;">
          <div class="progress-bar bg-pink" role="progressbar" style="width: ${
            ((step + 1) / visible.length) * 100
          }%; background: linear-gradient(to right, #ec4899, #a855f7)!important;"></div>
        </div>
      </div>
      <h4 class="mb-4">${current.question}</h4>
      ${extraNote}
      ${noteHtml}
      ${
        current.type === "multiple"
          ? '<small class="text-muted d-block mb-3">Pilih satu atau lebih (bisa pilih "Tidak ada" jika tidak ingin tambahan)</small>'
          : ""
      }
      ${optionsHtml}
      ${inputHtml}
      <div class="d-flex gap-3 mt-5">
        ${
          step > 0
            ? `<button class="btn btn-outline-secondary px-4" onclick="prevStep()">Kembali</button>`
            : ""
        }
        <button class="btn btn-primary px-5 flex-grow-1 btn-next" ${
          !isAnswered ? "disabled" : ""
        } onclick="nextStep()">
          ${
            step === visible.length - 1 ? "Selesai & Lihat Ringkasan" : "Lanjut"
          }
        </button>
      </div>
    `;

        if (current.type === "text" || current.type === "textarea") {
          const input = app.querySelector(
            "input.form-control, textarea.form-control",
          );
          if (input) {
            input.focus();
            input.selectionStart = input.selectionEnd = input.value.length;
          }
        }
      }

      render();
    </script>
  </body>
</html>
